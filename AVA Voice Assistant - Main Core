"""
AVA - Advanced Voice Assistant
Complete implementation with multimodal capabilities
"""

import speech_recognition as sr
import pyttsx3
import datetime
import webbrowser
import os
import sys
import requests
import wikipedia
import json
import threading
import time
from googletrans import Translator
import random
import subprocess
import platform

class AVA:
    def __init__(self):
        """Initialize AVA with all necessary components"""
        self.engine = pyttsx3.init()
        self.recognizer = sr.Recognizer()
        self.translator = Translator()
        self.is_listening = False
        self.conversation_memory = []
        self.user_preferences = self.load_preferences()
        self.personality_mode = "friendly"
        
        # Configure voice
        voices = self.engine.getProperty('voices')
        self.engine.setProperty('voice', voices[1].id if len(voices) > 1 else voices[0].id)
        self.engine.setProperty('rate', 175)
        self.engine.setProperty('volume', 0.9)
        
        # API Keys (add your own)
        self.WEATHER_API_KEY = "YOUR_OPENWEATHER_API_KEY"
        self.NEWS_API_KEY = "YOUR_NEWS_API_KEY"
        self.OPENAI_API_KEY = "YOUR_OPENAI_API_KEY"
        
        print("üéôÔ∏è AVA initialized successfully!")
        
    def speak(self, text):
        """Convert text to speech"""
        print(f"AVA: {text}")
        self.engine.say(text)
        self.engine.runAndWait()
        
    def listen(self):
        """Listen to user input via microphone"""
        try:
            with sr.Microphone() as source:
                print("üéß Listening...")
                self.recognizer.adjust_for_ambient_noise(source, duration=0.5)
                audio = self.recognizer.listen(source, timeout=5, phrase_time_limit=10)
                
            print("üîç Recognizing...")
            query = self.recognizer.recognize_google(audio, language='en-in')
            print(f"You: {query}")
            self.conversation_memory.append({"user": query, "time": datetime.datetime.now()})
            return query.lower()
            
        except sr.WaitTimeoutError:
            return "timeout"
        except sr.UnknownValueError:
            return "none"
        except sr.RequestError:
            self.speak("Sorry, my speech service is unavailable right now")
            return "none"
        except Exception as e:
            print(f"Error: {e}")
            return "none"
    
    def load_preferences(self):
        """Load user preferences from file"""
        try:
            with open('ava_preferences.json', 'r') as f:
                return json.load(f)
        except:
            return {
                "name": "User",
                "location": "Coimbatore",
                "favorite_music": [],
                "reminders": [],
                "todo_list": []
            }
    
    def save_preferences(self):
        """Save user preferences to file"""
        with open('ava_preferences.json', 'w') as f:
            json.dump(self.user_preferences, f, indent=4)
    
    def greet(self):
        """Greet the user based on time"""
        hour = datetime.datetime.now().hour
        if 0 <= hour < 12:
            greeting = "Good morning"
        elif 12 <= hour < 18:
            greeting = "Good afternoon"
        else:
            greeting = "Good evening"
        
        self.speak(f"{greeting} {self.user_preferences['name']}! I'm AVA, your personal assistant. How can I help you today?")
    
    # ========== SYSTEM CONTROL ==========
    
    def open_application(self, app_name):
        """Open applications on the system"""
        system = platform.system()
        
        apps = {
            "chrome": {"Windows": "chrome", "Darwin": "Google Chrome", "Linux": "google-chrome"},
            "youtube": {"url": "https://www.youtube.com"},
            "whatsapp": {"url": "https://web.whatsapp.com"},
            "spotify": {"url": "https://open.spotify.com"},
            "notepad": {"Windows": "notepad", "Darwin": "TextEdit"},
            "calculator": {"Windows": "calc", "Darwin": "Calculator"},
            "code": {"Windows": "code", "Darwin": "code", "Linux": "code"},
            "vscode": {"Windows": "code", "Darwin": "code", "Linux": "code"}
        }
        
        if app_name in apps:
            app_info = apps[app_name]
            if "url" in app_info:
                webbrowser.open(app_info["url"])
                self.speak(f"Opening {app_name}")
            else:
                try:
                    if system in app_info:
                        if system == "Windows":
                            os.system(f"start {app_info[system]}")
                        elif system == "Darwin":
                            os.system(f"open -a '{app_info[system]}'")
                        else:
                            os.system(f"{app_info[system]} &")
                        self.speak(f"Opening {app_name}")
                    else:
                        self.speak(f"Sorry, I don't know how to open {app_name} on this system")
                except:
                    self.speak(f"Sorry, I couldn't open {app_name}")
        else:
            self.speak(f"I don't have {app_name} in my database yet")
    
    def system_control(self, command):
        """Control system functions"""
        system = platform.system()
        
        if "volume up" in command:
            if system == "Windows":
                from ctypes import cast, POINTER
                from comtypes import CLSCTX_ALL
                from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume
                devices = AudioUtilities.GetSpeakers()
                interface = devices.Activate(IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
                volume = cast(interface, POINTER(IAudioEndpointVolume))
                current = volume.GetMasterVolumeLevelScalar()
                volume.SetMasterVolumeLevelScalar(min(1.0, current + 0.1), None)
            self.speak("Volume increased")
            
        elif "volume down" in command:
            if system == "Windows":
                from ctypes import cast, POINTER
                from comtypes import CLSCTX_ALL
                from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume
                devices = AudioUtilities.GetSpeakers()
                interface = devices.Activate(IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
                volume = cast(interface, POINTER(IAudioEndpointVolume))
                current = volume.GetMasterVolumeLevelScalar()
                volume.SetMasterVolumeLevelScalar(max(0.0, current - 0.1), None)
            self.speak("Volume decreased")
            
        elif "shutdown" in command:
            self.speak("Shutting down the system in 10 seconds. Say cancel to abort")
            # Add confirmation logic here
            
    # ========== INTERNET & KNOWLEDGE ==========
    
    def search_google(self, query):
        """Search Google and speak results"""
        search_query = query.replace("search", "").replace("google", "").strip()
        url = f"https://www.google.com/search?q={search_query}"
        webbrowser.open(url)
        self.speak(f"Here are the search results for {search_query}")
    
    def search_youtube(self, query):
        """Search YouTube"""
        search_query = query.replace("youtube", "").replace("search", "").strip()
        url = f"https://www.youtube.com/results?search_query={search_query}"
        webbrowser.open(url)
        self.speak(f"Here are the YouTube results for {search_query}")
    
    def get_weather(self, city=None):
        """Get weather information"""
        if not city:
            city = self.user_preferences.get("location", "Coimbatore")
        
        try:
            url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={self.WEATHER_API_KEY}&units=metric"
            response = requests.get(url)
            data = response.json()
            
            if data["cod"] == 200:
                temp = data["main"]["temp"]
                description = data["weather"][0]["description"]
                humidity = data["main"]["humidity"]
                
                self.speak(f"The temperature in {city} is {temp} degrees celsius with {description}. Humidity is {humidity} percent")
            else:
                self.speak("Sorry, I couldn't fetch the weather information")
        except:
            self.speak("Weather service is currently unavailable")
    
    def get_news(self):
        """Get latest news headlines"""
        try:
            url = f"https://newsapi.org/v2/top-headlines?country=in&apiKey={self.NEWS_API_KEY}"
            response = requests.get(url)
            data = response.json()
            
            articles = data.get("articles", [])[:5]
            self.speak("Here are the top news headlines")
            
            for i, article in enumerate(articles, 1):
                self.speak(f"Headline {i}: {article['title']}")
                
        except:
            self.speak("News service is currently unavailable")
    
    def search_wikipedia(self, query):
        """Search Wikipedia"""
        try:
            search_query = query.replace("wikipedia", "").replace("search", "").strip()
            result = wikipedia.summary(search_query, sentences=2)
            self.speak(result)
        except:
            self.speak("Sorry, I couldn't find that on Wikipedia")
    
    def translate_text(self, text, target_lang):
        """Translate text to target language"""
        try:
            lang_codes = {"hindi": "hi", "telugu": "te", "tamil": "ta", "english": "en"}
            target = lang_codes.get(target_lang, "hi")
            
            translation = self.translator.translate(text, dest=target)
            self.speak(f"Translation: {translation.text}")
        except:
            self.speak("Translation service is unavailable")
    
    # ========== PRODUCTIVITY ==========
    
    def add_reminder(self, reminder_text):
        """Add a reminder"""
        self.user_preferences["reminders"].append({
            "text": reminder_text,
            "time": datetime.datetime.now().isoformat()
        })
        self.save_preferences()
        self.speak(f"Reminder added: {reminder_text}")
    
    def add_todo(self, task):
        """Add task to todo list"""
        self.user_preferences["todo_list"].append({
            "task": task,
            "completed": False,
            "added": datetime.datetime.now().isoformat()
        })
        self.save_preferences()
        self.speak(f"Added to your todo list: {task}")
    
    def show_todo(self):
        """Show todo list"""
        todos = self.user_preferences["todo_list"]
        if not todos:
            self.speak("Your todo list is empty")
        else:
            self.speak(f"You have {len(todos)} tasks")
            for i, todo in enumerate(todos, 1):
                if not todo["completed"]:
                    self.speak(f"Task {i}: {todo['task']}")
    
    def tell_time(self):
        """Tell current time"""
        time = datetime.datetime.now().strftime("%I:%M %p")
        self.speak(f"The time is {time}")
    
    def tell_date(self):
        """Tell current date"""
        date = datetime.datetime.now().strftime("%B %d, %Y")
        self.speak(f"Today is {date}")
    
    # ========== ENTERTAINMENT ==========
    
    def tell_joke(self):
        """Tell a random joke"""
        jokes = [
            "Why don't scientists trust atoms? Because they make up everything!",
            "Why did the scarecrow win an award? Because he was outstanding in his field!",
            "What do you call a fake noodle? An impasta!",
            "Why don't eggs tell jokes? They'd crack each other up!",
            "What do you call a bear with no teeth? A gummy bear!"
        ]
        self.speak(random.choice(jokes))
    
    def play_music(self, song_name):
        """Play music on YouTube"""
        url = f"https://www.youtube.com/results?search_query={song_name}"
        webbrowser.open(url)
        self.speak(f"Playing {song_name} on YouTube")
    
    # ========== MAIN COMMAND PROCESSOR ==========
    
    def process_command(self, command):
        """Process user commands"""
        
        if "hello" in command or "hi" in command:
            self.speak("Hello! How can I help you?")
        
        elif "your name" in command or "who are you" in command:
            self.speak("I am AVA, your Advanced Voice Assistant, created to make your life easier")
        
        elif "time" in command:
            self.tell_time()
        
        elif "date" in command:
            self.tell_date()
        
        elif "open" in command:
            app = command.replace("open", "").strip()
            self.open_application(app)
        
        elif "search google" in command or "google search" in command:
            self.search_google(command)
        
        elif "youtube" in command:
            if "search" in command:
                self.search_youtube(command)
            else:
                self.open_application("youtube")
        
        elif "weather" in command:
            self.get_weather()
        
        elif "news" in command:
            self.get_news()
        
        elif "wikipedia" in command:
            self.search_wikipedia(command)
        
        elif "translate" in command:
            # Simple implementation
            self.speak("What should I translate?")
            text = self.listen()
            if text != "none":
                self.speak("To which language?")
                lang = self.listen()
                if lang != "none":
                    self.translate_text(text, lang)
        
        elif "reminder" in command:
            reminder = command.replace("reminder", "").replace("add", "").strip()
            self.add_reminder(reminder)
        
        elif "todo" in command or "task" in command:
            if "add" in command:
                task = command.replace("add", "").replace("todo", "").replace("task", "").strip()
                self.add_todo(task)
            elif "show" in command or "list" in command:
                self.show_todo()
        
        elif "joke" in command:
            self.tell_joke()
        
        elif "play" in command:
            song = command.replace("play", "").strip()
            self.play_music(song)
        
        elif "volume up" in command or "increase volume" in command:
            self.system_control("volume up")
        
        elif "volume down" in command or "decrease volume" in command:
            self.system_control("volume down")
        
        elif "stop" in command or "exit" in command or "quit" in command:
            self.speak("Goodbye! Have a great day!")
            return False
        
        else:
            self.speak("I'm not sure how to help with that yet. Can you try asking differently?")
        
        return True
    
    def run(self):
        """Main run loop"""
        self.greet()
        
        while True:
            self.speak("Listening for 'Hey AVA'")
            command = self.listen()
            
            if "hey ava" in command or "hi ava" in command:
                self.speak("Yes, I'm listening")
                user_command = self.listen()
                
                if user_command != "none" and user_command != "timeout":
                    continue_listening = self.process_command(user_command)
                    if not continue_listening:
                        break

if __name__ == "__main__":
    assistant = AVA()
    assistant.run()
